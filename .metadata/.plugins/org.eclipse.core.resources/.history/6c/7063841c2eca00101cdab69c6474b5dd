package com.example.videostream.service;
import org.apache.commons.io.input.BoundedInputStream;
9
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.InputStreamResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.multipart.MultipartFile;
import javax.annotation.PostConstruct;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.UUID;
@Service
public class StorageService {
private final Path root;
public StorageService(@Value("${app.storage.path}") String storagePath) {
this.root = Paths.get(storagePath).toAbsolutePath().normalize();
}
@PostConstruct
public void init() throws IOException {
Files.createDirectories(root);
}
public String store(MultipartFile file) throws IOException {
String original = StringUtils.cleanPath(file.getOriginalFilename());
String ext = "";
int i = original.lastIndexOf('.');
if (i >= 0) ext = original.substring(i);
String stored = UUID.randomUUID().toString() + ext;
Path target = root.resolve(stored);
try (InputStream in = file.getInputStream(); OutputStream out =
Files.newOutputStream(target)) {
in.transferTo(out);
}
return stored;
}
public File getFile(String filename) {
return root.resolve(filename).toFile();
}
public Resource getResourceRegion(String filename, long start, long
length) throws FileNotFoundException {
File file = getFile(filename);
FileInputStream fis = new FileInputStream(file);
fis.skip(start);
10
BoundedInputStream bis = new BoundedInputStream(fis, length);
return new InputStreamResource(bis);
}
public Resource getResource(String filename) throws
FileNotFoundException {
File file = getFile(filename);
return new InputStreamResource(new FileInputStream(file));
}
public long getSize(String filename) {
File file = getFile(filename);
return file.length();
}
public boolean delete(String filename) {
try {
Files.deleteIfExists(root.resolve(filename));
return true;
} catch (IOException e) {
return false;
}
}
}